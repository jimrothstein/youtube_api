---
title: "`r knitr::current_input()`"
date: "`r paste('last updated', 
    format(lubridate::now(), ' %d %B %Y'))`"
output:   
  html_document:  
        code_folding: show
        toc: true 
        toc_depth: 2
        toc_float: true
  pdf_document:   
    latex_engine: xelatex  
    toc: true
    toc_depth:  2   
    fontsize: 11pt   
    geometry: margin=0.5in,top=0.25in   
---

---- PURPOSE ----
given ONE playlist, return list of videos
HERE:  re-write so get_videos(playlist) return all videos in ONE playlist
----------------

### SEE 013_get_all_videos.Rmd
*   retrieve ALL videos for ALL playlists



```{r setup, include=FALSE		}
knitr::opts_chunk$set(echo = TRUE,  
											comment="      ##",  
											error=TRUE, 
											collapse=TRUE)
load_all()
```

```{r initialize}
```
## Functions

### get_query()
```{r query}

# return query
get_query  <- function(playlistId, api, l) {
    query  <- list(
                   part="snippet",  
                   maxResults=l$maxResults,  
        playlistId= l$playlistId,	
        fields=paste(sep=", ",   
          "nextPageToken",   
          "items(snippet(title, description, position ))"  
          ),  
        key=api$api_key)  
}

```
### check with HEAD
```{r check}

## check against HEAD
```{r}
r  <- httr::HEAD(url =  base_url,
                query = query,
                config = httr::config(token = auth.code))

r
```

### process_batch()
```{r process}



# return videos tibble
process_batch  <- function(r, videos){
	json_content <- get_json(r)
	next_videos <- json_content$items$snippet
  nextPageToken  <<- httr::config(token = auth.code)
	videos <- rbind(videos, next_videos)
}

```

## Run  Query
```{r}
r  <- httr::GET(url =  base_url,
                query = query,
                config = httr::config(token = auth.code))

r
```

### get_first_batch_videos
```{r first_batch}

get_first_batch_videos  <- function(playlistId){ 
  query  <- get_query(playlistId, api, l)

  r  <- httr::GET(url =  base_url,
                query = query,
                config = httr::config(token = auth.code))
  nextPageToken   <<- httr::content(r)$nextPageToken
  videos  <- process_batch(r, videos)
}

```

### get_next_batch
```{r next_batch}

get_next_batch_videos   <- function(base_url, query, config) {
      query  <- get_query(playlistId, api, l)
      query$nextPageToken  <- nextPageToken
      
      r  <- httr::GET(url =  base_url,
                query = query,
                config = httr::config(token = auth.code))

			# process
      videos  <- process_batch(r, videos)
}

```

combine 1st batch + additional (if any)
```{r all_videos_ONE_playlist}



# all togther!
get_playlist_videos  <- function(playlistId){
  browser()
  videos  <- NULL
  nextPageToken  <- NULL
  auth.code  <- getOption("auth.code")
  auth.code

  videos  <- get_first_batch_videos(playlistId)
  videos

  
  while (!is.null(nextPageToken))
			 query$pageToken  <- nextPageToken 
       r  <- get_next_batch_videos (base_url, query, config)
       videos  <- process_batch(r, videos)
}

if (!exists("api")) api <- get_api_codes()
if (!exists("l")) l   <- get_typical_values()
api
l

base_url <- "https://www.googleapis.com/youtube/v3/playlistItems"

if (is.null(l$playlistId)) l$playlistId <- "PLbcglKxZP5PN07Vw-0ukcDJCxFGY2Crgc"

l$playlistId
get_playlist_videos( l$playlistId)
```


```{r}
saveRDS(videos, file=here::here("data/videos.RDS"))
```

```{r}

```
cleanup videos
```{r cleanup}
t  <- videos %>% select(title, position) %>% 
	dplyr::arrange(title)

```

```{r knit_exit(), eval=FALSE }
knitr::knit_exit()
```
gg
```{r render, eval=FALSE	}
here()
file <- "rmd/012_get_videos.Rmd"
file  <- basename(file)
dir="rmd"

jimTools::ren_pdf(file,dir)
jimTools::ren_github(file, dir)
```
